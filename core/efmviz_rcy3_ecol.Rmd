---
output:
  pdf_document: default
  html_document: default
---
Studying acetate overflow metabolism of E. coli through visualization of Elementary Flux Modes (EFMs)

This code is part of the analysis used in the study: 
"An integrative workflow to visualize Elementary Flux Modes in genome-scale metabolic models", Sarathy et al. (2019) (in preparation)

It was used for visualizing the EFMs that were selected after running the script <>. 
First, the the SBML file(s) created in the mlx script are loaded into Cytoscape. 
After which a set of functions from RCy3 are called to perform network layout operations and mapping reaction fluxes on the visualized network. 
This automation allows users to visualize multiple EFMs in shorter time. 
---
title: "efmviz_rcy3_ecoli"
author: "Chaitra Sarathy"
date: "July 11, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

EPENDENCIES
- R libraries: RCy3
- Cytpscape (v 3.5 and above)
- Cytpscape apps: cy3sbml, yFiles Layout

INPUTS
- EFM saved as an SBML file (as generated from <>)
- Data file: Comma separated text file containing two columns, reaction names (column name - rxnID) and flux values (column name - fluxVector), as generated from <>
- Network style file provided under core/R/<>

OUTPUTS
EFM from E. coli that was selected from <> is visualized as a network of genes, reactions and metabolites with reaction fluxes mapped on the edges in the network.

-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
DO THIS IN THE CYTOSCAPE GUI:

Importing SBML file in Cytoscape through cy3sbml
1. Open Cytoscape (v 3.5 and above) and make sure cy3sbml app has been installed. If installing for the first time, a Cytoscape restart maybe necessary
2. Click on the cy3sbl app-specific icon and select the EFM (SBML submodel file which was generated from MATLAB) to open
Three networks are generated for every file imported and they are respectively identified using the prefixes: All, Base and Kinetic. 
3. Click on the Base network and run the script below. (Other two networks, All and Kinetic may be deleted from GUI)
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
Before running this script, declare file locations and file names. 
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
NOTE: CHANGE THE NAMES OF ONLY THESE VARIABLES
```{r}
# usecase1_fileName = "C:/Users/chaitra.sarathy/Dropbox/Chaitra/Analysis/EFM/visualizationOfEFMs/githubVersion/data/data_useCase_1.xlsx"
usecase1_fileName = "C:/Users/chaitra.sarathy/Dropbox/Chaitra/Analysis/EFM/visualizationOfEFMs/githubVersion/results/useCase1/ecolidataForMapping_EFM_68.txt"
styleName = "efmviz_style"
sheetNum = 4
```
Install and load necessary R packages
```{r}
if("RCy3" %in% rownames(installed.packages()) == FALSE) {install.packages("RCy3")}
if("readxl" %in% rownames(installed.packages()) == FALSE) {install.packages("readxl")}
if("RColorBrewer" %in% rownames(installed.packages()) == FALSE) {install.packages("RColorBrewer")}
if("rstudioapi" %in% rownames(installed.packages()) == FALSE) {install.packages("rstudioapi")}

library(RCy3)
library(readxl)
library(RColorBrewer)
library(rstudioapi)
```

Make sure the connection between R and Cytoscape works
```{r}
cytoscapePing() #must return "You are connected to Cytoscape!"
```
cytoscapePing() must return "You are connected to Cytoscape!". If not, Cytoscape needs a restart.
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
MAKE SURE THE BASE NETWORK IS SELECTED IN CYTOSCAPE

Import and apply the provided style file 
```{r}
setVisualStyle(style.name = styleName)
```
Updates to the style that was applied above
# Color reaction nodes as green
```{r}
clearSelection()
setNodeColorBypass(node.names = getSelectedNodes(selectNodes(nodes = "reaction", by.col = "sbml type")), new.colors = "#00FF00" )
```

Extract node table
Get node table of the network to modify node display labels - remove lengthy reaction IDs which are then mapped back on the network

```{r}
# Get four columns label (default value of label), name (node identifier), sbml type (for filtering nodes later) and cyId (will be used for assigning identifiers for edges)
nodeTab = getTableColumns(table = "node", columns = c("label", "name","sbml type", "cyId"))
nodeTab[,"nodeLabels"] = character()
nodeTab$nodeLabels = nodeTab$label
```

# Remove reaction label
```{r}
nodeTab$nodeLabels[which(nodeTab$`sbml type` == "reaction")] = ""
```
# Load the updated node table into Cytoscape 
```{r}
loadTableData(data = nodeTab, data.key.column = "label", table = "node", table.key.column = "label")
```

# Remap node labels to new label
```{r}
updateStyleMapping(style.name = styleName, mapVisualProperty('node label', 'nodeLabels','p'))
```

# Hide genes and GPR relation nodes
```{r}
clearSelection()
hideNodes(node.names = getSelectedNodes(selectNodes(nodes = "fbc_geneProduct", by.col = "sbml type")))
clearSelection()
hideNodes(node.names = getSelectedNodes(selectNodes(nodes = "fbc_and", by.col = "sbml type")))
clearSelection()
hideNodes(node.names = getSelectedNodes(selectNodes(nodes = "fbc_or", by.col = "sbml type")))
clearSelection()
```
Map reaction fluxes

# Load reaction flux
```{r}
# reactionFlux <- read_excel(usecase1_fileName, sheet = sheetNum)
reactionFlux <- read.csv(file=usecase1_fileName)
```
Extract the edge table and assign flux value to each edge
In this network, the edges did not have any unique identifiers. 
So, identifier of each reaction node was copied onto all the connected reactant and product nodes using the section below.
# Get the edge table
```{r}
edgeTab = getTableColumns(table = "edge", columns = c("interaction type"))
edgeTab$edgeID = rownames(edgeTab)
edgeTab[,"edgeName"] = character()
```
# Get all reaction nodes
```{r}
rxnNodes = getSelectedNodes(selectNodes(nodes = "reaction", by.col = "sbml type"))
clearSelection()
```
# for each reaction node, get associated edges
# for each edge if interaction type is is reaction-product or reaction-reaction, add the reaction id as edge identifier

NOTE: This for loop will take long time for big networks    

```{r}
for (ii in rxnNodes){
  rxnEdges = selectEdgesAdjacentToSelectedNodes(selectNodes(nodes = ii, by.col = "shared name"))$edges
  for (jj in rxnEdges){
    ind = which(edgeTab$edgeID == jj)
    if (edgeTab$`interaction type`[ind] == "reaction-product" || edgeTab$`interaction type`[ind] == "reaction-reactant"){
      edgeTab$edgeName[ind] = nodeTab$cyId[match(ii, nodeTab$name)]
    }
  }
  clearSelection()
}
# The prefix was removed since the data file did not contain the same prefix for reaction IDs 
edgeTab$edgeName = gsub("^R_", "",  edgeTab$edgeName)
```
# Make sure flux data in edge table is numeric
```{r}
edgeTab[,"fluxData"] = numeric()
edgeTab$fluxData = reactionFlux$fluxVector[match(edgeTab$edgeName, reactionFlux$rxnID)]
edgeTab[which(is.na(edgeTab$fluxData)), 4] = 0
edgeTab$fluxData <- signif(edgeTab$fluxData,2)
```
# Load the modified edge table, now containing edge IDs and flux values to Cytoscape
```{r}
loadTableData(data = edgeTab, data.key.column = "edgeID", table = "edge", table.key.column = "SUID")
```
# Map the flux data on the edges, set edge color and edge weight
```{r}
setEdgeLineWidthMapping('fluxData', c(0,30), c(2,15), style.name=styleName)
setEdgeColorDefault("#969696", style.name=styleName)
setEdgeColorMapping('fluxData', c(0,1,30), c("#999999","#FFCCCC","#FF0000"), style.name=styleName)
```
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------
DO THIS IN THE CYTOSCAPE GUI:
To apply layout, click Layout --> yFiles Orthogonal Layout